import{u as x,r as h,a as l,b as V,j as e}from"./index-BePcEgSx.js";import{D as Y,L as C}from"./diceLadder-C_chWhqf.js";import{u as B,a as G,M as H}from"./useThread-Bebspp80.js";import{T}from"./Tooltip-Ccd3z65E.js";import{u as J}from"./useSession-D8PDgnbH.js";import{u as p}from"./useMutation-PSJ-S_qC.js";import"./useQuery-B-hF3On-.js";function U(){const s=x();return p({mutationFn:()=>h.roll(),onSuccess:()=>{s.invalidateQueries({queryKey:["session"]}),s.invalidateQueries({queryKey:["session","current"]}),s.invalidateQueries({queryKey:["threads"]})}})}function W(){const s=x();return p({mutationFn:r=>h.override(r),onSuccess:()=>{s.invalidateQueries({queryKey:["session"]}),s.invalidateQueries({queryKey:["session","current"]}),s.invalidateQueries({queryKey:["threads"]})}})}function X(){const s=x();return p({mutationFn:r=>h.setDie(r),onSuccess:()=>{s.invalidateQueries({queryKey:["session"]})}})}function Z(){const s=x();return p({mutationFn:()=>h.clearManualDie(),onSuccess:()=>{s.invalidateQueries({queryKey:["session"]})}})}function ne(){const[s,r]=l.useState(!1),[M,g]=l.useState(null),[j,m]=l.useState(null),[c,y]=l.useState(6),[q,I]=l.useState("idle"),[f,O]=l.useState(null),[P,b]=l.useState(!1),[d,N]=l.useState(""),{data:a}=J(),{data:Q}=B(),{data:u}=G(7),w=V(),k=X(),S=Z(),E=U(),v=W(),D=Q?.filter(t=>t.status==="active")??[];l.useEffect(()=>{a?.current_die&&y(a.current_die),a?.last_rolled_result&&g(a.last_rolled_result)},[a]),l.useEffect(()=>{if(u&&u.length>0){const t=u[0],o=t.last_activity_at?new Date(t.last_activity_at):new Date(t.created_at),n=new Date-o,i=Math.floor(n/(1e3*60*60*24));i>=7&&O({...t,days:i})}},[u]);const K=a?.current_die||6,_=D.slice(0,K)||[];function R(t){I(t),console.log("[RollPage] Dice state set to:",t)}function A(t){y(t),k.mutate(t)}function L(){S.mutate()}function $(){if(s)return;m(null),r(!0),R("idle");let t=0;const o=10,n=setInterval(()=>{t++,t>=o&&(clearInterval(n),setTimeout(()=>{E.mutate(void 0,{onSuccess:i=>{i?.result&&g(i.result),i?.thread_id&&m(i.thread_id),r(!1),w("/rate")},onError:()=>r(!1)})},400))},80);return()=>clearInterval(n)}function z(){R("rolled")}function F(t){t.preventDefault(),d&&v.mutate({thread_id:Number(d)},{onSuccess:()=>{b(!1),N(""),w("/rate")}})}return a?e.jsxs("div",{className:"h-screen flex flex-col overflow-hidden",children:[e.jsxs("header",{className:"flex justify-between items-center px-3 py-2 shrink-0 z-10",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-black tracking-tighter text-glow uppercase",children:"Pile Roller"}),e.jsx("p",{className:"text-[9px] font-bold text-slate-500 uppercase tracking-widest",children:"Active session"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[a.has_restore_point&&e.jsxs("div",{className:"flex items-center gap-1 px-2 py-1 bg-teal-500/10 border border-teal-500/20 rounded-lg",children:[e.jsx("span",{className:"text-xs",children:"ðŸ›¡ï¸"}),e.jsx("span",{className:"text-[9px] font-black text-teal-400 uppercase",children:"Session Safe"})]}),e.jsxs("div",{className:"relative",id:"die-selector",children:[Y.map(t=>e.jsxs("button",{onClick:()=>A(t),disabled:k.isPending,className:`die-btn px-2 py-1 text-[10px] font-black rounded-lg border transition-colors ${t===c?"bg-teal-500/20 border-teal-500 text-teal-400":"bg-white/5 border-white/10 hover:bg-white/10"}`,children:["d",t]},t)),e.jsx("button",{onClick:L,disabled:S.isPending,className:`px-2 py-1 text-[10px] font-black rounded-lg border transition-colors ${a.manual_die?"bg-amber-500/20 border-amber-500 text-amber-400":"bg-white/5 border-white/10 hover:bg-white/10"}`,title:a.manual_die?`Exit manual mode (currently d${a.manual_die})`:"Return to automatic dice ladder mode",children:"Auto"})]}),e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1 bg-white/5 rounded-xl border border-white/10 shrink-0",children:[e.jsx("div",{className:"relative flex items-center justify-center",style:{width:"40px",height:"40px"},children:e.jsx("div",{className:"w-full h-full",children:e.jsx(C,{sides:c,value:1,isRolling:!1,showValue:!1,color:16777215})})}),e.jsxs("div",{className:"text-right",children:[e.jsx(T,{content:"Dice ladder: d4â†’d6â†’d8â†’d10â†’d12â†’d20. Promotes automatically based on ratings (5â†’up, 1-2â†’down)",children:e.jsx("span",{className:"block text-[8px] font-black text-slate-500 uppercase tracking-wider cursor-help border-b border-dashed border-slate-600",children:"Ladder"})}),e.jsxs("span",{id:"header-die-label",className:"text-[10px] font-black text-teal-400",children:["d",c]})]})]}),e.jsx(T,{content:"Manually select a thread to override the next roll result.",children:e.jsx("button",{type:"button",onClick:()=>b(!0),className:"px-3 py-2 bg-white/5 border border-white/10 text-slate-300 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-white/10 transition-all",children:"Override"})})]})]}),e.jsx("div",{className:"flex-1 overflow-auto flex flex-col",children:e.jsxs("div",{className:"glass-card flex-1 flex flex-col relative overflow-hidden",children:[e.jsx("div",{className:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-80 h-80 bg-indigo-600/10 rounded-full blur-[120px] pointer-events-none"}),e.jsx("div",{id:"main-die-3d",onClick:$,className:`dice-state-${q} relative z-10 cursor-pointer shrink-0 flex items-center justify-center rounded-full transition-all`,style:{width:"200px",height:"200px",margin:"0 auto"},children:e.jsx("div",{className:"w-full h-full",children:e.jsx(C,{sides:c,value:M||1,isRolling:s,showValue:!1,color:16777215,onRollComplete:z})})}),!s&&e.jsx("p",{id:"tap-instruction",className:"text-slate-500 font-black uppercase tracking-[0.5em] text-[9px] animate-pulse shrink-0 text-center",children:"Tap Die to Roll"}),e.jsxs("div",{className:"flex-1 min-h-0 mt-4 px-4 pb-4 overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center gap-2 shrink-0",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-teal-500 shadow-[0_0_15px_var(--accent-teal)]"}),e.jsx("span",{className:"text-[10px] font-black uppercase tracking-widest text-slate-500",children:"Roll Pool"})]}),e.jsx("div",{className:"flex-1 overflow-y-auto mt-2 space-y-2 scrollbar-thin",children:_.length===0?e.jsx("div",{className:"text-center py-10 text-slate-600 font-black uppercase tracking-widest text-[10px]",children:"Queue Empty"}):_.map((t,o)=>{const n=j&&parseInt(j,10)===t.id;return e.jsxs("div",{onClick:()=>m(t.id),className:`flex items-center gap-3 px-4 py-2 bg-white/5 border border-white/5 rounded-xl group transition-all ${n?"pool-thread-selected":""}`,children:[e.jsx("span",{className:"text-lg font-black text-slate-500/50 group-hover:text-slate-400/50 transition-colors",children:o+1}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-black text-slate-300 truncate text-sm",children:t.title}),e.jsx("p",{className:"text-[8px] font-black text-slate-500 uppercase tracking-widest",children:t.format})]})]},t.id)})})]}),f&&e.jsx("div",{className:"px-4 pb-4 shrink-0 animate-[fade-in_0.5s_ease-out]",children:e.jsxs("div",{className:"px-4 py-3 bg-amber-500/5 border border-amber-500/10 rounded-xl flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-amber-500/10 rounded-lg flex items-center justify-center shrink-0",children:e.jsx("span",{className:"text-sm",children:"â³"})}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("p",{className:"text-[10px] font-bold text-amber-200/70 uppercase tracking-wider leading-relaxed",children:["You haven't touched ",e.jsx("span",{className:"text-amber-400 font-black",children:f.title})," in"," ",e.jsx("span",{className:"text-amber-400 font-black",children:f.days})," days"]})})]})})]})}),e.jsx("div",{id:"explosion-layer",className:"explosion-wrap"}),e.jsx(H,{isOpen:P,title:"Override Roll",onClose:()=>b(!1),children:e.jsxs("form",{className:"space-y-4",onSubmit:F,children:[e.jsx("p",{className:"text-xs text-slate-400",children:"Pick a thread to force the next roll result."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-[10px] font-bold uppercase tracking-widest text-slate-500",children:"Thread"}),e.jsxs("select",{value:d,onChange:t=>N(t.target.value),className:"w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm text-slate-200",required:!0,children:[e.jsx("option",{value:"",children:"Select a thread..."}),D.map(t=>e.jsxs("option",{value:t.id,children:[t.title," (",t.format,")"]},t.id))]})]}),e.jsx("button",{type:"submit",disabled:v.isPending||!d,className:"w-full py-3 glass-button text-xs font-black uppercase tracking-widest disabled:opacity-60",children:v.isPending?"Overriding...":"Override Roll"})]})})]}):e.jsx("div",{className:"text-center py-10 text-slate-500 font-black uppercase tracking-widest text-[10px]",children:"Loading..."})}export{ne as default};
