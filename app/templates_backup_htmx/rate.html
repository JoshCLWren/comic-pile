{% extends "base.html" %}

{% block content %}
<div class="space-y-8 pb-10">
    <header class="flex justify-between items-center px-2">
        <div>
            <h1 class="text-4xl font-black tracking-tighter text-glow mb-1 uppercase">Rate Session</h1>
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Mark your progress</p>
        </div>
        <div class="flex items-center gap-3">
            <div id="session-safe-indicator" class="hidden flex items-center gap-1 px-2 py-1 bg-teal-500/10 border border-teal-500/20 rounded-lg">
                <span class="text-xs">üõ°Ô∏è</span>
                <span class="text-[9px] font-black text-teal-400 uppercase">Session Safe</span>
            </div>
            <div id="header-die-container" class="dice-perspective relative"
                style="width: 50px; height: 50px; transform: scale(0.4);">
                <!-- Die injected by JS -->
                <span id="header-die-state-label" class="absolute -bottom-3 left-1/2 -translate-x-1/2 text-[7px] font-bold uppercase tracking-wider text-slate-500 opacity-0 transition-opacity duration-300 whitespace-nowrap"></span>
            </div>
        </div>
    </header>

    <div class="glass-card p-10 space-y-12 relative overflow-hidden max-w-3xl mx-auto">
        <div id="glow-bg"
            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-teal-600/10 rounded-full blur-[100px] transition-colors duration-500">
        </div>

        <div id="thread-info" role="status" aria-live="polite">
            <div class="h-24 bg-white/5 rounded-3xl animate-pulse"></div>
        </div>

        <div class="space-y-12 relative z-10">
            <div id="rating-preview-dice" class="dice-perspective mb-4">
                <div id="die-preview-wrapper" class="dice-state-rate-flow relative flex items-center justify-center" style="width: 120px; height: 120px; margin: 0 auto;">
                    <div id="die-preview" class="die-3d w-full h-full"></div>
                    <span id="die-preview-state-label" class="absolute -bottom-5 left-1/2 -translate-x-1/2 text-[8px] font-bold uppercase tracking-wider text-indigo-400">Rating</span>
                </div>
            </div>

            <div class="text-center space-y-6">
                <p class="text-[10px] font-black uppercase tracking-[0.4em] text-slate-500">How was it?</p>
                <div id="rating-value" class="text-teal-400">4.0</div>
                <input type="range" id="rating-input" name="rating" min="0.5" max="5.0" step="0.5" value="4.0"
                    class="w-full h-4" oninput="updateUI(this.value)">
            </div>

            <div class="p-6 bg-teal-500/5 rounded-3xl border border-teal-500/20 shadow-xl">
                <p id="queue-effect"
                    class="text-xs font-black text-slate-200 text-center uppercase tracking-[0.15em] leading-relaxed">
                </p>
            </div>

            <button type="button" id="submit-btn" onclick="submitRating(false)"
                class="w-full py-6 glass-button text-xl font-black uppercase tracking-[0.2em] relative shadow-[0_15px_40px_rgba(20,184,166,0.3)]">
                Save & Continue
            </button>
            <button type="button" id="finish-btn" onclick="submitRating(true)"
                class="w-full py-4 text-lg font-black uppercase tracking-[0.2em] text-slate-400 hover:text-slate-300 transition-colors">
                Finish Session
            </button>
            <div id="error-message" class="text-xs text-rose-500 text-center font-bold hidden"></div>
        </div>

        <div id="result-message" class="text-center" role="status" aria-live="polite"></div>
    </div>
</div>

<div id="explosion-layer" class="explosion-wrap top-0 left-0 w-full h-full"></div>

<script>
    const DICE_LADDER = [4, 6, 8, 10, 12, 20];
    let currentDenom = 6;
    let headerDie = null;
    let previewDie = null;
    let previewSides = null;

    function updateUI(val) {
        const num = parseFloat(val);
        const display = document.getElementById('rating-value');
        const effect = document.getElementById('queue-effect');
        const diePreview = document.getElementById('die-preview');
        const dieWrapper = document.getElementById('die-preview-wrapper');

        display.textContent = num.toFixed(1);
        let predictedDie = currentDenom;

        if (num >= 4.0) {
            display.className = 'text-teal-400';
            display.style.textShadow = '0 0 40px rgba(20, 184, 166, 1)';
            effect.parentElement.className = 'p-6 bg-teal-500/5 rounded-3xl border border-teal-500/20 shadow-xl';

            const idx = DICE_LADDER.indexOf(currentDenom);
            if (idx > 0) {
                effect.innerHTML = 'Excellent! Die steps down üé≤ Move to front';
                predictedDie = DICE_LADDER[idx - 1];
            } else {
                effect.innerHTML = 'Already at minimum üé≤ Die stays at d4';
                predictedDie = DICE_LADDER[idx];
            }
        } else {
            display.className = 'text-indigo-400';
            display.style.textShadow = '0 0 40px rgba(79, 70, 229, 1)';
            effect.parentElement.className = 'p-6 bg-indigo-500/5 rounded-3xl border border-indigo-500/20 shadow-xl';

            const idx = DICE_LADDER.indexOf(currentDenom);
            if (idx < DICE_LADDER.length - 1) {
                effect.innerHTML = 'Okay. Die steps up üé≤ Move to back';
                predictedDie = DICE_LADDER[idx + 1];
            } else {
                effect.innerHTML = 'Already at maximum üé≤ Die stays at d20';
                predictedDie = DICE_LADDER[idx];
            }
        }

        if (previewDie && previewSides !== predictedDie) {
            previewDie.setSides(predictedDie);
            previewSides = predictedDie;
        }

        if (dieWrapper) {
            dieWrapper.classList.remove('dice-state-rate-flow');
            dieWrapper.classList.add('dice-state-rate-flow');
        }
    }

    async function checkRestorePointBeforeSubmit() {
        try {
            const res = await fetch('/sessions/current/');
            const session = await res.json();

            if (!session.has_restore_point) {
                const confirmed = confirm('‚ö†Ô∏è No restore point available!\n\nYou are about to make a destructive action that cannot be undone. Continue anyway?');
                return confirmed;
            }
            return true;
        } catch (e) {
            console.error('[RatePage] Failed to check restore point:', e);
            return true;
        }
    }

    async function submitRating(finishSession) {
        const ratingInput = document.getElementById('rating-input');
        const rating = ratingInput ? parseFloat(ratingInput.value) : 4.0;
        const btn = document.getElementById('submit-btn');
        const finishBtn = document.getElementById('finish-btn');
        const err = document.getElementById('error-message');

        console.log('[RatePage] Submitting rating:', rating, 'finish_session:', finishSession);
        if (err) err.classList.add('hidden');

        const canProceed = await checkRestorePointBeforeSubmit();
        if (!canProceed) {
            btn.disabled = false;
            if (finishBtn) finishBtn.disabled = false;
            btn.textContent = 'Save & Continue';
            return;
        }

        if (rating >= 4.0) {
            console.log('[RatePage] Triggering explosion');
            const layer = document.getElementById('explosion-layer');
            const count = 50;
            for (let i = 0; i < count; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                const angle = Math.random() * Math.PI * 2;
                const dist = 150 + Math.random() * 250;
                p.style.left = '50%'; p.style.top = '50%';
                p.style.setProperty('--tx', Math.cos(angle) * dist + 'px');
                p.style.setProperty('--ty', Math.sin(angle) * dist + 'px');
                p.style.background = i % 2 ? 'var(--accent-teal)' : 'var(--accent-violet)';
                layer.appendChild(p);
                setTimeout(() => p.remove(), 1000);
            }
        }

        btn.disabled = true;
        if (finishBtn) finishBtn.disabled = true;
        btn.innerHTML = '<span class="spinner mx-auto"></span>';

        try {
            console.log('[RatePage] Fetching /rate/...');
            const res = await fetch('/rate/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rating, issues_read: 1, finish_session: finishSession })
            });
            console.log('[RatePage] Response status:', res.status);
            if (res.ok) {
                console.log('[RatePage] Success! Redirecting...');
                setTimeout(() => window.location.href = '/', 1200);
            } else {
                const data = await res.json();
                console.error('[RatePage] Failure:', data);
                if (err) {
                    err.textContent = data.detail || 'Failed to save';
                    err.classList.remove('hidden');
                }
                btn.disabled = false;
                if (finishBtn) finishBtn.disabled = false;
                btn.textContent = 'Retry';
            }
        } catch (e) {
            console.error('[RatePage] Error:', e);
            btn.disabled = false;
            if (finishBtn) finishBtn.disabled = false;
            btn.textContent = 'Network Error';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (window.Dice3D) {
            Dice3D.cleanup();
        }

        fetch('/sessions/current/')
            .then(res => res.json())
            .then(data => {
                const info = document.getElementById('thread-info');
                const headerDieContainer = document.getElementById('header-die-container');
                const diePreview = document.getElementById('die-preview');
                const dieWrapper = document.getElementById('die-preview-wrapper');
                const safeIndicator = document.getElementById('session-safe-indicator');

                if (safeIndicator) {
                    if (data.has_restore_point) {
                        safeIndicator.classList.remove('hidden');
                        safeIndicator.classList.add('flex');
                    } else {
                        safeIndicator.classList.add('hidden');
                        safeIndicator.classList.remove('flex');
                    }
                }

                if (data.active_thread) {
                    currentDenom = data.current_die || 6;
                    const rolledValue = data.last_rolled_result || 1;
                    if (window.Dice3D) {
                        headerDie = Dice3D.create(headerDieContainer, currentDenom, { color: 0xffffff, showValue: false });
                        previewDie = Dice3D.create(diePreview, currentDenom, { color: 0xffffff, showValue: false });
                        previewSides = currentDenom;
                        if (previewDie) previewDie.rollTo(rolledValue);
                    }

                    if (dieWrapper) {
                        dieWrapper.classList.add('dice-state-rate-flow');
                    }

                    info.innerHTML = `
                        <div class="space-y-2 text-center">
                            <h2 class="text-3xl font-black text-slate-100">${data.active_thread.title}</h2>
                            <div class="flex items-center justify-center gap-3">
                                <span class="bg-indigo-500/20 text-indigo-300 px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-[0.2em] border border-indigo-500/20">${data.active_thread.format}</span>
                                <span class="text-slate-500 text-xs font-bold">${data.active_thread.issues_remaining} Issues left</span>
                            </div>
                        </div>
                    `;
                    updateUI(4.0);
                } else {
                    info.innerHTML = '<div class="text-center p-10 text-slate-500 font-black">Session Inactive</div>';
                    document.getElementById('submit-btn').disabled = true;
                }
            });
    });
</script>
{% endblock %}
