{% extends "base.html" %}

{% block content %}
<div class="space-y-8 pb-10">
    <header class="flex justify-between items-center px-4 py-2">
        <div>
            <h1 class="text-3xl font-black tracking-tighter text-glow uppercase">Pile Roller</h1>
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Active session</p>
        </div>
        <div class="flex items-center gap-3 px-4 py-2 bg-white/5 rounded-2xl border border-white/10 shadow-2xl">
            <div id="header-die-container" class="dice-perspective"
                style="width: 40px; height: 40px; transform: scale(0.4);">
            </div>
            <div class="text-right">
                <span class="block text-[9px] font-black text-slate-500 uppercase tracking-wider">Ladder</span>
                <span id="header-die-label" class="text-xs font-black text-teal-400">d{{ current_die }}</span>
            </div>
        </div>
    </header>

    <div id="result" class="space-y-8" role="region" aria-live="polite">
        <div id="roll-container" class="glass-card p-12 flex flex-col items-center relative overflow-hidden">
            <div
                class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-80 h-80 bg-indigo-600/10 rounded-full blur-[120px]">
            </div>

            <div id="main-die-wrapper" class="dice-perspective relative z-10 cursor-pointer" onclick="rollTheDie()">
                <div id="die-3d" class="die-3d d{{ current_die }}" hx-post="/roll/html" hx-trigger="triggerRoll"
                    hx-target="#result" hx-swap="innerHTML">
                </div>
            </div>

            <p id="tap-instruction"
                class="mt-14 text-slate-500 font-black uppercase tracking-[0.5em] text-[10px] animate-pulse">Tap Die to
                Roll</p>

            <div id="pool-display" class="w-full mt-16 space-y-4">
                <div class="flex items-center justify-between px-2">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-teal-500 shadow-[0_0_15px_var(--accent-teal)]"></div>
                        <span class="text-xs font-black uppercase tracking-widest text-slate-500">Roll Pool</span>
                    </div>
                </div>
                <div id="pool-threads" class="space-y-3">
                    <div class="h-14 bg-white/5 rounded-2xl animate-pulse"></div>
                    <div class="h-14 bg-white/5 rounded-2xl animate-pulse"></div>
                </div>
            </div>

            <div id="stale-suggestion" class="w-full mt-8 hidden transition-all animate-[fade-in_0.5s_ease-out]">
                <div class="px-5 py-4 bg-amber-500/5 border border-amber-500/10 rounded-2xl flex items-center gap-4">
                    <div class="w-10 h-10 bg-amber-500/10 rounded-xl flex items-center justify-center">
                        <span class="text-lg">‚è≥</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p id="stale-text"
                            class="text-[11px] font-bold text-amber-200/70 uppercase tracking-wider leading-relaxed">
                            You haven't touched <span class="text-amber-400 font-black">Title</span> in <span
                                class="text-amber-400 font-black">X</span> days
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="explosion-layer" class="explosion-wrap"></div>

<script>
    console.log('[RollPage] Script Initialization Started');

    // Global State
    const DICE_LADDER = [4, 6, 8, 10, 12, 20];
    const initialDenom = {{ current_die }};
    let rolledResult = null;
    let threadId = null;

    function renderDieFaces(container, dieType, result = null) {
        if (!container) return;
        const sides = parseInt(dieType);
        let html = '<div class="die-core"></div>';
        for (let i = 1; i <= sides; i++) {
            const val = (result && i === 1) ? result : i;
            html += `<div class="die-face face-${i}">${val}</div>`;
        }
        container.innerHTML = html;
        container.className = `die-3d d${dieType}`;
        if (result && dieType == 6) container.classList.add('show-1');
    }

    function rollTheDie() {
        console.log('[RollPage] rollTheDie called');
        const die = document.getElementById('die-3d');
        const instruction = document.getElementById('tap-instruction');
        if (die.classList.contains('die-spinning')) return;

        die.classList.add('die-spinning');
        if (instruction) instruction.textContent = "Rolling...";

        setTimeout(() => {
            console.log('[RollPage] Triggering HTMX roll event');
            htmx.trigger('#die-3d', 'triggerRoll');
        }, 1200);
    }

    function createExplosion() {
        const layer = document.getElementById('explosion-layer');
        if (!layer) return;
        const count = 70;
        const x = window.innerWidth / 2;
        const y = window.innerHeight / 2;

        for (let i = 0; i < count; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            const angle = Math.random() * Math.PI * 2;
            const dist = 100 + Math.random() * 400;
            p.style.left = x + 'px'; p.style.top = y + 'px';
            p.style.setProperty('--tx', Math.cos(angle) * dist + 'px');
            p.style.setProperty('--ty', Math.sin(angle) * dist + 'px');
            p.style.background = i % 2 ? 'var(--accent-teal)' : 'var(--accent-violet)';
            layer.appendChild(p);
            setTimeout(() => p.remove(), 1200);
        }
    }

    async function loadRollPool() {
        try {
            console.log('[RollPage] Loading Roll Pool');
            const res = await fetch('/threads/');
            const threads = await res.json();
            const sessionRes = await fetch('/sessions/current/');
            const session = await sessionRes.json();
            const container = document.getElementById('pool-threads');
            if (!container) return;

            const dieSize = session.current_die || 6;
            const pool = threads.slice(0, dieSize);

            if (pool.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-slate-600 font-black uppercase tracking-widest text-[10px]">Queue Empty</div>';
                return;
            }

            container.innerHTML = pool.map((t, i) => `
                <div class="flex items-center gap-4 p-5 bg-white/5 border border-white/5 rounded-2xl group transition-all">
                    <span class="text-2xl font-black text-white/5 group-hover:text-white/10 transition-colors">${i + 1}</span>
                    <div class="flex-1 min-w-0">
                        <p class="font-black text-slate-300 truncate">${t.title}</p>
                        <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest">${t.format}</p>
                    </div>
                </div>
            `).join('');
        } catch (e) {
            console.error('[RollPage] Failed to load pool:', e);
        }
    }

    // HTMX Logging & Global Handlers
    document.body.addEventListener('htmx:afterRequest', (evt) => {
        console.log('[RollPage] HTMX afterRequest target:', evt.detail.target.id, 'Status:', evt.detail.xhr.status);
    });

    function updateRatingDisplay(val) {
        const display = document.getElementById('rating-value');
        const preview = document.getElementById('rating-preview');
        const dieResult = document.getElementById('die-result');
        const num = parseFloat(val);
        display.textContent = num.toFixed(1);

        let predictedDie = initialDenom;
        if (num >= 4.0) {
            display.className = 'text-teal-400';
            const idx = DICE_LADDER.indexOf(initialDenom);
            predictedDie = idx > 0 ? DICE_LADDER[idx - 1] : DICE_LADDER[0];
            preview.innerHTML = 'Excellent! Die steps down üé≤ Move to front';
        } else {
            display.className = 'text-indigo-400';
            const idx = DICE_LADDER.indexOf(initialDenom);
            predictedDie = idx < DICE_LADDER.length - 1 ? DICE_LADDER[idx + 1] : DICE_LADDER[DICE_LADDER.length - 1];
            preview.innerHTML = 'Okay. Die steps up üé≤ Move to back';
        }

        if (dieResult && dieResult.dataset.currentType != predictedDie) {
            renderDieFaces(dieResult, predictedDie, rolledResult);
            dieResult.dataset.currentType = predictedDie;
        }
    }

    async function submitRating() {
        const ratingInput = document.getElementById('rating-input');
        const rating = ratingInput ? parseFloat(ratingInput.value) : 4.0;
        const btn = document.getElementById('submit-rating-btn');
        const errorDisplay = document.getElementById('error-message');

        console.log('[RollPage] submitRating START:', rating);
        if (rating >= 4.0) createExplosion();

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner mx-auto"></span>';
        if (errorDisplay) errorDisplay.classList.add('hidden');

        try {
            const res = await fetch('/rate/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rating, issues_read: 1 })
            });
            console.log('[RollPage] Response status:', res.status);
            if (res.ok) {
                setTimeout(() => window.location.href = '/', 1200);
            } else {
                const errData = await res.json();
                if (errorDisplay) {
                    errorDisplay.textContent = errData.detail || "Error saving rating";
                    errorDisplay.classList.remove('hidden');
                }
                btn.disabled = false;
                btn.textContent = 'Retry';
            }
        } catch (e) {
            console.error('[RollPage] submitRating FATAL:', e);
            btn.disabled = false;
            btn.innerHTML = 'Network Error! Retry?';
        }
    }

    async function loadStaleSuggestion() {
        try {
            console.log('[RollPage] Checking for stale threads');
            const res = await fetch('/threads/stale?days=7');
            const staleThreads = await res.json();
            const container = document.getElementById('stale-suggestion');
            const textSpan = document.getElementById('stale-text');

            if (staleThreads && staleThreads.length > 0) {
                const thread = staleThreads[0];
                const lastActivity = thread.last_activity_at ? new Date(thread.last_activity_at) : new Date(thread.created_at);
                const diffMs = new Date() - lastActivity;
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                if (diffDays >= 7) {
                    textSpan.innerHTML = `You haven't touched <span class="text-amber-400 font-black">${thread.title}</span> in <span class="text-amber-400 font-black">${diffDays}</span> days`;
                    container.classList.remove('hidden');
                }
            }
        } catch (e) {
            console.error('[RollPage] Failed to load stale suggestion:', e);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        console.log('[RollPage] DOMContentLoaded');
        renderDieFaces(document.getElementById('die-3d'), initialDenom);
        const headerContainer = document.getElementById('header-die-container');
        if (headerContainer) {
            const mini = document.createElement('div');
            renderDieFaces(mini, initialDenom);
            headerContainer.appendChild(mini);
        }
        loadRollPool();
        loadStaleSuggestion();
    });
</script>
{% endblock %}