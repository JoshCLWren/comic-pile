{% extends "base.html" %}

{% block content %}
<style>
    body { padding-bottom: 0 !important; }
    main { padding: 0 !important; height: calc(100dvh - 5rem); max-width: 100%; }
</style>

<div class="h-full flex flex-col overflow-hidden">
    <header class="flex justify-between items-center px-3 py-2 shrink-0 z-10">
        <div>
            <h1 class="text-2xl font-black tracking-tighter text-glow uppercase">Pile Roller</h1>
            <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">Active session</p>
        </div>
        <div class="flex items-center gap-2 px-3 py-1 bg-white/5 rounded-xl border border-white/10 shrink-0">
            <div id="header-die-container" class="flex items-center justify-center" style="width: 40px; height: 40px;">
                <svg id="header-die-svg" viewBox="0 0 100 100" class="w-8 h-8"></svg>
            </div>
            <div class="text-right">
                <span class="block text-[8px] font-black text-slate-500 uppercase tracking-wider">Ladder</span>
                <span id="header-die-label" class="text-[10px] font-black text-teal-400">d{{ current_die }}</span>
            </div>
        </div>
    </header>

    <div id="result" class="flex-1 overflow-auto flex flex-col" role="region" aria-live="polite">
        <div id="roll-container" class="glass-card flex-1 flex flex-col relative overflow-hidden">
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-80 h-80 bg-indigo-600/10 rounded-full blur-[120px] pointer-events-none"></div>

            <div id="main-die-wrapper" class="relative z-10 cursor-pointer shrink-0 flex items-center justify-center" style="width: 200px; height: 200px;" onclick="rollTheDie()">
                <svg id="main-die-svg" viewBox="0 0 100 100" class="w-48 h-48 transition-all duration-300"></svg>
            </div>

            <p id="tap-instruction"
                class="text-slate-500 font-black uppercase tracking-[0.5em] text-[9px] animate-pulse shrink-0">Tap Die to
                Roll</p>

            <div id="pool-display" class="flex-1 min-h-0 mt-4 px-4 pb-4 overflow-hidden flex flex-col">
                <div class="flex items-center gap-2 shrink-0">
                    <div class="w-2 h-2 rounded-full bg-teal-500 shadow-[0_0_15px_var(--accent-teal)]"></div>
                    <span class="text-[10px] font-black uppercase tracking-widest text-slate-500">Roll Pool</span>
                </div>
                <div id="pool-threads" class="flex-1 overflow-y-auto mt-2 space-y-2 scrollbar-thin">
                    <div class="h-10 bg-white/5 rounded-xl animate-pulse"></div>
                    <div class="h-10 bg-white/5 rounded-xl animate-pulse"></div>
                </div>
            </div>

            <div id="stale-suggestion" class="px-4 pb-4 shrink-0 hidden transition-all animate-[fade-in_0.5s_ease-out]">
                <div class="px-4 py-3 bg-amber-500/5 border border-amber-500/10 rounded-xl flex items-center gap-3">
                    <div class="w-8 h-8 bg-amber-500/10 rounded-lg flex items-center justify-center shrink-0">
                        <span class="text-sm">‚è≥</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p id="stale-text"
                            class="text-[10px] font-bold text-amber-200/70 uppercase tracking-wider leading-relaxed">
                            You haven't touched <span class="text-amber-400 font-black">Title</span> in <span
                                class="text-amber-400 font-black">X</span> days
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="explosion-layer" class="explosion-wrap"></div>

<script>
    console.log('[RollPage] Script Initialization Started');

    const DICE_LADDER = [4, 6, 8, 10, 12, 20];
    const initialDenom = {{ current_die }};
    let rolledResult = null;
    let threadId = null;
    let isRolling = false;
    let currentDieValue = 1;

    function getDieSVG(dieType, value, color = '#4f46e5') {
        const baseSVG = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                    <feDropShadow dx="2" dy="4" stdDeviation="3" flood-opacity="0.3"/>
                </filter>
            </defs>
            ${getDieShape(dieType, color)}
            ${getDiePips(dieType, value)}
        </svg>`;
        return baseSVG;
    }

    function getDieShape(dieType, color) {
        const shapes = {
            4: `<polygon points="50,10 90,80 10,80" fill="${color}" stroke="#1e1b4b" stroke-width="2" filter="url(#shadow)"/>`,
            6: `<rect x="10" y="10" width="80" height="80" rx="12" fill="${color}" stroke="#1e1b4b" stroke-width="2" filter="url(#shadow)"/>`,
            8: `<polygon points="50,5 95,30 95,80 50,95 5,80 5,30" fill="${color}" stroke="#1e1b4b" stroke-width="2" filter="url(#shadow)"/>`,
            10: `<polygon points="50,10 95,50 50,95 5,50" fill="${color}" stroke="#1e1b4b" stroke-width="2" filter="url(#shadow)"/>`,
            12: `<polygon points="50,5 95,35 95,75 50,95 5,75 5,35" fill="${color}" stroke="#1e1b4b" stroke-width="2" filter="url(#shadow)"/>`,
            20: `<polygon points="50,5 90,30 90,60 50,85 10,60 10,30" fill="${color}" stroke="#1e1b4b" stroke-width="2" filter="url(#shadow)"/>`
        };
        return shapes[dieType] || shapes[6];
    }

    function getDiePips(dieType, value) {
        const pips = {
            4: getD4Pips(value),
            6: getD6Pips(value),
            8: getD8Pips(value),
            10: getD10Pips(value),
            12: getD12Pips(value),
            20: getD20Pips(value)
        };
        return pips[dieType] || '';
    }

    function getD4Pips(value) {
        const positions = {
            1: [[50, 50]],
            2: [[35, 45], [65, 55]],
            3: [[35, 45], [50, 60], [65, 55]],
            4: [[35, 45], [65, 45], [50, 65], [50, 35]]
        };
        return positions[value]?.map(([x, y]) => 
            `<circle cx="${x}" cy="${y}" r="4" fill="white" opacity="0.9"/>`
        ).join('') || `<circle cx="50" cy="50" r="4" fill="white" opacity="0.9"/>`;
    }

    function getD6Pips(value) {
        const positions = {
            1: [[50, 50]],
            2: [[30, 30], [70, 70]],
            3: [[30, 30], [50, 50], [70, 70]],
            4: [[30, 30], [70, 30], [30, 70], [70, 70]],
            5: [[30, 30], [70, 30], [50, 50], [30, 70], [70, 70]],
            6: [[30, 30], [70, 30], [30, 50], [70, 50], [30, 70], [70, 70]]
        };
        return positions[value]?.map(([x, y]) => 
            `<circle cx="${x}" cy="${y}" r="5" fill="white" opacity="0.9"/>`
        ).join('') || '';
    }

    function getD8Pips(value) {
        const positions = {
            1: [[50, 45]],
            2: [[35, 40], [65, 50]],
            3: [[35, 40], [50, 50], [65, 60]],
            4: [[35, 35], [65, 40], [35, 60], [65, 65]],
            5: [[35, 35], [65, 40], [50, 50], [35, 60], [65, 65]],
            6: [[35, 35], [65, 38], [35, 50], [65, 52], [35, 65], [65, 68]],
            7: [[35, 35], [65, 38], [50, 45], [35, 55], [65, 58], [35, 70], [65, 73]],
            8: [[35, 35], [65, 38], [50, 45], [35, 55], [65, 58], [50, 65], [35, 72], [65, 75]]
        };
        return positions[value]?.map(([x, y]) => 
            `<circle cx="${x}" cy="${y}" r="4" fill="white" opacity="0.9"/>`
        ).join('') || '';
    }

    function getD10Pips(value) {
        const positions = {
            1: [[50, 50]],
            2: [[35, 40], [65, 60]],
            3: [[35, 40], [50, 55], [65, 70]],
            4: [[35, 35], [65, 40], [35, 65], [65, 70]],
            5: [[35, 35], [65, 40], [50, 50], [35, 65], [65, 70]],
            6: [[35, 35], [65, 38], [35, 52], [65, 55], [35, 70], [65, 73]],
            7: [[35, 35], [65, 38], [50, 45], [35, 55], [65, 58], [35, 72], [65, 75]],
            8: [[35, 32], [65, 36], [35, 47], [65, 51], [35, 65], [65, 69], [35, 82], [65, 86]],
            9: [[35, 32], [65, 36], [50, 42], [35, 55], [65, 59], [35, 72], [65, 76], [50, 82], [65, 86]],
            10: [[35, 30], [65, 34], [35, 45], [65, 49], [50, 55], [35, 68], [65, 72], [35, 85], [65, 89], [50, 92]]
        };
        return positions[value]?.map(([x, y]) => 
            `<circle cx="${x}" cy="${y}" r="3.5" fill="white" opacity="0.9"/>`
        ).join('') || '';
    }

    function getD12Pips(value) {
        const positions = {
            1: [[50, 45]],
            2: [[35, 40], [65, 55]],
            3: [[35, 40], [50, 55], [65, 70]],
            4: [[30, 35], [70, 40], [30, 65], [70, 70]],
            5: [[30, 35], [70, 40], [50, 50], [30, 65], [70, 70]],
            6: [[30, 35], [70, 38], [30, 52], [70, 55], [30, 70], [70, 73]],
            7: [[30, 35], [70, 38], [50, 45], [30, 55], [70, 58], [30, 72], [70, 75]],
            8: [[30, 35], [70, 38], [30, 50], [70, 53], [50, 60], [30, 72], [70, 77], [50, 82]],
            9: [[30, 32], [70, 36], [50, 42], [30, 55], [70, 59], [50, 65], [30, 78], [70, 82], [50, 88]],
            10: [[30, 30], [70, 34], [30, 45], [70, 49], [50, 55], [30, 68], [70, 72], [30, 85], [70, 89], [50, 92]],
            11: [[30, 30], [70, 34], [50, 40], [30, 52], [70, 56], [50, 62], [30, 75], [70, 79], [50, 85], [30, 90], [70, 94]],
            12: [[30, 30], [70, 34], [30, 45], [70, 49], [50, 55], [30, 65], [70, 69], [50, 75], [30, 85], [70, 89], [50, 93], [70, 96]]
        };
        return positions[value]?.map(([x, y]) => 
            `<circle cx="${x}" cy="${y}" r="3.2" fill="white" opacity="0.9"/>`
        ).join('') || '';
    }

    function getD20Pips(value) {
        const positions = {
            1: [[50, 45]],
            2: [[35, 40], [65, 55]],
            3: [[35, 40], [50, 55], [65, 70]],
            4: [[28, 35], [72, 40], [28, 65], [72, 70]],
            5: [[28, 35], [72, 40], [50, 50], [28, 65], [72, 70]],
            6: [[28, 35], [72, 38], [28, 52], [72, 55], [28, 70], [72, 73]],
            7: [[28, 35], [72, 38], [50, 45], [28, 55], [72, 58], [28, 72], [72, 75]],
            8: [[28, 35], [72, 38], [28, 50], [72, 53], [50, 60], [28, 72], [72, 77], [50, 82]],
            9: [[28, 32], [72, 36], [50, 42], [28, 55], [72, 59], [50, 65], [28, 78], [72, 82], [50, 88]],
            10: [[28, 30], [72, 34], [28, 45], [72, 49], [50, 55], [28, 68], [72, 72], [28, 85], [72, 89], [50, 92]],
            11: [[28, 30], [72, 34], [50, 40], [28, 52], [72, 56], [50, 62], [28, 75], [72, 79], [50, 85], [28, 90], [72, 94]],
            12: [[28, 30], [72, 34], [28, 45], [72, 49], [50, 55], [28, 65], [72, 69], [50, 75], [28, 85], [72, 89], [50, 93], [72, 96]],
            13: [[25, 28], [75, 32], [50, 38], [25, 50], [75, 54], [50, 60], [25, 72], [75, 76], [50, 82], [25, 92], [75, 96], [50, 98], [75, 100]],
            14: [[25, 28], [75, 32], [25, 43], [75, 47], [50, 53], [25, 63], [75, 67], [50, 73], [25, 83], [75, 87], [50, 93], [25, 98], [75, 102], [50, 105]],
            15: [[25, 28], [75, 32], [50, 38], [25, 50], [75, 54], [50, 60], [25, 72], [75, 76], [50, 82], [25, 92], [75, 96], [50, 100], [25, 105], [75, 108], [50, 110]],
            16: [[25, 28], [75, 32], [25, 43], [75, 47], [25, 55], [75, 59], [50, 65], [25, 75], [75, 79], [50, 85], [25, 95], [75, 99], [25, 105], [75, 108], [50, 112], [75, 114]],
            17: [[25, 28], [75, 32], [50, 38], [25, 50], [75, 54], [25, 62], [75, 66], [50, 72], [25, 82], [75, 86], [50, 92], [25, 100], [75, 104], [25, 108], [75, 112], [50, 115], [75, 117]],
            18: [[25, 28], [75, 32], [25, 43], [75, 47], [25, 55], [75, 59], [50, 65], [25, 75], [75, 79], [50, 85], [25, 95], [75, 99], [25, 107], [75, 111], [50, 115], [25, 118], [75, 120], [50, 123]],
            19: [[25, 28], [75, 32], [50, 38], [25, 50], [75, 54], [25, 62], [75, 66], [50, 72], [25, 82], [75, 86], [25, 95], [75, 99], [50, 105], [25, 112], [75, 116], [50, 120], [25, 124], [75, 126], [50, 128]],
            20: [[25, 28], [75, 32], [25, 43], [75, 47], [25, 55], [75, 59], [50, 65], [25, 75], [75, 79], [50, 85], [25, 95], [75, 99], [25, 107], [75, 111], [50, 115], [25, 120], [75, 124], [25, 128], [75, 132], [50, 135], [75, 137]]
        };
        return positions[value]?.map(([x, y]) => 
            `<circle cx="${x}" cy="${y}" r="2.8" fill="white" opacity="0.9"/>`
        ).join('') || '';
    }

    function updateDieDisplay(dieType, value, svgId) {
        const svg = document.getElementById(svgId);
        if (!svg) return;
        svg.innerHTML = getDieSVG(dieType, value);
        currentDieValue = value;
    }

    function rollTheDie() {
        console.log('[RollPage] rollTheDie called');
        if (isRolling) return;

        isRolling = true;
        const instruction = document.getElementById('tap-instruction');
        if (instruction) instruction.textContent = "Rolling...";

        const wrapper = document.getElementById('main-die-wrapper');
        const svg = document.getElementById('main-die-svg');

        let rollCount = 0;
        const maxRolls = 10;
        const rollInterval = setInterval(() => {
            const randomValue = Math.floor(Math.random() * initialDenom) + 1;
            updateDieDisplay(initialDenom, randomValue, 'main-die-svg');
            rollCount++;

            if (rollCount >= maxRolls) {
                clearInterval(rollInterval);
                const finalValue = Math.floor(Math.random() * initialDenom) + 1;
                updateDieDisplay(initialDenom, finalValue, 'main-die-svg');
                currentDieValue = finalValue;
                rolledResult = finalValue;

                setTimeout(() => {
                    console.log('[RollPage] Triggering HTMX roll event');
                    htmx.trigger('#main-die-wrapper', 'triggerRoll');
                }, 500);
            }
        }, 100);
    }

    function createExplosion() {
        const layer = document.getElementById('explosion-layer');
        if (!layer) return;
        const count = 70;
        const x = window.innerWidth / 2;
        const y = window.innerHeight / 2;

        for (let i = 0; i < count; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            const angle = Math.random() * Math.PI * 2;
            const dist = 100 + Math.random() * 400;
            p.style.left = x + 'px';
            p.style.top = y + 'px';
            p.style.setProperty('--tx', Math.cos(angle) * dist + 'px');
            p.style.setProperty('--ty', Math.sin(angle) * dist + 'px');
            p.style.background = i % 2 ? 'var(--accent-teal)' : 'var(--accent-violet)';
            layer.appendChild(p);
            setTimeout(() => p.remove(), 1200);
        }
    }

    async function loadRollPool() {
        try {
            console.log('[RollPage] Loading Roll Pool');
            const res = await fetch('/threads/');
            const threads = await res.json();
            const sessionRes = await fetch('/sessions/current/');
            const session = await sessionRes.json();
            const container = document.getElementById('pool-threads');
            if (!container) return;

            const dieSize = session.current_die || 6;
            const pool = threads.slice(0, dieSize);

            if (pool.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-slate-600 font-black uppercase tracking-widest text-[10px]">Queue Empty</div>';
                return;
            }

            container.innerHTML = pool.map((t, i) => `
                <div class="flex items-center gap-3 px-4 py-2 bg-white/5 border border-white/5 rounded-xl group transition-all">
                    <span class="text-lg font-black text-white/5 group-hover:text-white/10 transition-colors">${i + 1}</span>
                    <div class="flex-1 min-w-0">
                        <p class="font-black text-slate-300 truncate text-sm">${t.title}</p>
                        <p class="text-[8px] font-black text-slate-500 uppercase tracking-widest">${t.format}</p>
                    </div>
                </div>
            `).join('');
        } catch (e) {
            console.error('[RollPage] Failed to load pool:', e);
        }
    }

    document.body.addEventListener('htmx:afterRequest', (evt) => {
        console.log('[RollPage] HTMX afterRequest target:', evt.detail.target.id, 'Status:', evt.detail.xhr.status);
    });

    function updateRatingDisplay(val) {
        const display = document.getElementById('rating-value');
        const preview = document.getElementById('rating-preview');
        const num = parseFloat(val);
        display.textContent = num.toFixed(1);

        let predictedDie = initialDenom;
        if (num >= 4.0) {
            display.className = 'text-teal-400';
            const idx = DICE_LADDER.indexOf(initialDenom);
            predictedDie = idx > 0 ? DICE_LADDER[idx - 1] : DICE_LADDER[0];
            preview.innerHTML = 'Excellent! Die steps down üé≤ Move to front';
        } else {
            display.className = 'text-indigo-400';
            const idx = DICE_LADDER.indexOf(initialDenom);
            predictedDie = idx < DICE_LADDER.length - 1 ? DICE_LADDER[idx + 1] : DICE_LADDER[DICE_LADDER.length - 1];
            preview.innerHTML = 'Okay. Die steps up üé≤ Move to back';
        }

        const headerDieSVG = document.getElementById('header-die-svg');
        if (headerDieSVG) {
            headerDieSVG.innerHTML = getDieSVG(predictedDie, 1);
            document.getElementById('header-die-label').textContent = 'd' + predictedDie;
        }
    }

    async function submitRating() {
        const ratingInput = document.getElementById('rating-input');
        const rating = ratingInput ? parseFloat(ratingInput.value) : 4.0;
        const btn = document.getElementById('submit-rating-btn');
        const errorDisplay = document.getElementById('error-message');

        console.log('[RollPage] submitRating START:', rating);
        if (rating >= 4.0) createExplosion();

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner mx-auto"></span>';
        if (errorDisplay) errorDisplay.classList.add('hidden');

        try {
            const res = await fetch('/rate/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rating, issues_read: 1 })
            });
            console.log('[RollPage] Response status:', res.status);
            if (res.ok) {
                setTimeout(() => window.location.href = '/roll', 1200);
            } else {
                const errData = await res.json();
                if (errorDisplay) {
                    errorDisplay.textContent = errData.detail || "Error saving rating";
                    errorDisplay.classList.remove('hidden');
                }
                btn.disabled = false;
                btn.textContent = 'Retry';
            }
        } catch (e) {
            console.error('[RollPage] submitRating FATAL:', e);
            btn.disabled = false;
            btn.innerHTML = 'Network Error! Retry?';
        }
    }

    async function loadStaleSuggestion() {
        try {
            console.log('[RollPage] Checking for stale threads');
            const res = await fetch('/threads/stale?days=7');
            const staleThreads = await res.json();
            const container = document.getElementById('stale-suggestion');
            const textSpan = document.getElementById('stale-text');

            if (staleThreads && staleThreads.length > 0) {
                const thread = staleThreads[0];
                const lastActivity = thread.last_activity_at ? new Date(thread.last_activity_at) : new Date(thread.created_at);
                const diffMs = new Date() - lastActivity;
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                if (diffDays >= 7) {
                    textSpan.innerHTML = `You haven't touched <span class="text-amber-400 font-black">${thread.title}</span> in <span class="text-amber-400 font-black">${diffDays}</span> days`;
                    container.classList.remove('hidden');
                }
            }
        } catch (e) {
            console.error('[RollPage] Failed to load stale suggestion:', e);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        console.log('[RollPage] DOMContentLoaded');

        updateDieDisplay(initialDenom, 1, 'main-die-svg');
        updateDieDisplay(initialDenom, 1, 'header-die-svg');

        loadRollPool();
        loadStaleSuggestion();
    });
</script>
{% endblock %}
